name: Create Release

on:
  workflow_run:
    workflows: ["Build Windows Executable"]
    types:
      - completed
    branches:
      - main

jobs:
  release:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    
    steps:
      - name: Download artifact
        uses: actions/github-script@v7
        with:
          script: |
            const artifacts = await github.rest.actions.listWorkflowRunArtifacts({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: ${{ github.event.workflow_run.id }}
            })
            const matchArtifact = artifacts.data.artifacts.find(artifact => artifact.name === "bustle-windows")
            if (!matchArtifact) {
              core.setFailed('No artifact found')
              return
            }
            const download = await github.rest.actions.downloadArtifact({
              owner: context.repo.owner,
              repo: context.repo.repo,
              artifact_id: matchArtifact.id,
              archive_format: 'zip'
            })
            const fs = require('fs')
            fs.writeFileSync('artifact.zip', Buffer.from(download.data))
      
      - name: Extract artifact
        run: unzip artifact.zip
      
      - name: Get version info
        id: version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            echo "is_tag=true" >> $GITHUB_OUTPUT
            echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          else
            echo "is_tag=false" >> $GITHUB_OUTPUT
            echo "version=pre-release-$(date +'%Y%m%d%H%M%S')" >> $GITHUB_OUTPUT
          fi
      
      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: ${{ steps.version.outputs.is_tag == 'true' && format('Release {0}', steps.version.outputs.version) || 'Development Build' }}
          draft: false
          prerelease: ${{ steps.version.outputs.is_tag != 'true' }}
          generate_release_notes: true
          files: bustle.exe
